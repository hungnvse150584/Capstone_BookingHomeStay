<!DOCTYPE html>
<html>
<head>
    <title>Customer Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h2>Customer Chat</h2>
    <div id="messages"></div>
    <input id="messageInput" type="text" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub?userId=" + senderId)
            .build();

        connection.on("ReceiveMessage", (senderId, content, sentAt, messageId, conversationId, senderName, receiverId) => {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("p");
            messageElement.textContent = `${senderName} (${senderId}): ${content} (${new Date(sentAt).toLocaleString()})`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Cuộn xuống tin nhắn mới nhất
            console.log(`Received message: ${senderName} (${senderId}): ${content}`);
        });

        connection.start().then(() => {
            console.log("SignalR connected for customer with userId:", senderId);
        }).catch(error => console.error("SignalR connection error:", error));

        function sendMessage() {
            const content = document.getElementById("messageInput").value;
            if (!content) return; // Không gửi nếu nội dung rỗng

            fetch('/api/chat/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    senderID: senderId,
                    receiverID: receiverId,
                    content: content,
                    senderName: senderName,
                    homeStayId: homeStayId
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("Message sent:", data);
                    document.getElementById("messageInput").value = ""; // Xóa input sau khi gửi

                    // Gọi API để lấy gợi ý chi tiết
                    fetch('/api/chat/detailed-suggestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            customerMessage: content,
                            homeStayId: homeStayId
                        })
                    })
                        .then(response => response.json())
                        .then(suggestions => {
                            console.log("Detailed suggestions:", suggestions);
                        })
                        .catch(error => console.error("Error fetching detailed suggestions:", error));
                })
                .catch(error => console.error("Error sending message:", error));
        }

        // Giả lập các biến
        const senderId = "customer456";
        const receiverId = "owner123";
        const senderName = "Customer";
        const homeStayId = 1;
    </script>
</body>
</html>